<!DOCTYPE html>
<html>

<head>
  <title>Socket.IO chat</title>

</head>

<body>
  <button id="connect">connect</button>
  <button class="offerButton">Make an offer</button>
  <button class="Accept">Accept Call</button>
  <script src="/socket.io/socket.io.js"></script>
  <div id="cells">
    <div id="user">
    </div>
  </div>
  <script>
    var socket = io();
    var userName = "patoche" + Math.random();

    socket.emit("request", msg = { type: "login", name: userName });



    /*
    var firstName = ...
    var lastName = ...
   */
    /*
      document.getElementById("connect").addEventListener("click", function (event) {
        socket.emit("request", { type: "login", name: userName + Math.random() });
      });
  */

    var userList = new Array();

    var options = {
      optional: [
        { DtlsSrtpKeyAgreement: true },
        { RtpDataChannels: true }
      ]
    }


    var cells = document.getElementById("cells");
    socket.on("getUsers", users => {
      for (let i = 0; i < users.length; i++) {
        addUsers(users[i]);
      }
    });

    function addUsers(user) {
      userList.push(user);
      let id = userList.length;
      //Add to the list of user on the UI 
      cells.innerHTML += `<div id="user${id}">${user}
                              <button class="offerButton" id="${user}">Make an offer</button>
                          </div>`
    }

    socket.on("newUser", user => {
      addUsers(user);
    });

    socket.on("connectedUsers", usersAlreadyConnected => {
      for (let i = 0; i < usersAlreadyConnected.length; i++) {
        addUsers(usersAlreadyConnected[i]);
      }
    });

    //'''''''''''''''''''''''''''Caller side''''''''''''''''''''''''''''''''//

    // callee accepted the offer 
    socket.on("answer", receiverName => {
      //création sdp et envoi de sdp puis de ICE
      //côté caller
      var callee = receiverName;
      console.log("Connexion accepté" + receiverName);

      //Creating the caller peer connection and his sdp
      var pcCaller = new RTCPeerConnection(options);
      var CallerSdp = pcCaller.createOffer();
      //Sending the caller sdp to the callee  
      socket.emit("request", { type: "sdpCaller", name: receiverName, sdp: CallerSdp })
      //Setting the caller (his) local description
      await pcCaller.setLocalDescription();
    });
    //Waiting for callee sdp 

    // when callee send spd info
    socket.on("calleeSdp", async calleeSdp => {
      //Caller set callee description
      const remoteDesc = new RTCSessionDescription(calleeSdp);
      await pcCaller.setRemoteDescription(remoteDesc);
      //Then 
      //Caller listen to his peerconnection for some icecandidate and when one is found the caller send it to the callee 
      pcCaller.addEventListener('icecandidate', event => {
        if (event.candidate) {
          socket.emit("request", { type: 'iceCandidate', name: callee, candidate: event.candidate });
        }
      });

    });
    // Listen for connectionstatechange on the local RTCPeerConnection
    pcCaller.addEventListener('connectionstatechange', event => {
      if (pcCaller.connectionState === 'connected') {
        // Peers connected!
        console.log("GGWP peers connected!")
      }
    });


    //-----------------------------Callee side----------------------------------//

    // callee received an offer from the caller 
    socket.on("offer", senderName => {
      console.log("Demande de connexion de:" + senderName);
      cells.innerHTML += `<button class=acceptButton id=${userName}>Accept offer send by:${senderName}</button>`;
    });


    //receiving a peerConnection offer from the caller (send by the signaling server)
    socket.on("pcOffer", async callerSdp => {
      //creating the callee peer connection
      var pcCallee = new RTCPeerConnection(options);
      //Setting the caller sdp description
      await pcCallee.setRemoteDescription(callerSdp);
      //Creating the callee sdp answer 
      var calleeSdp = pcCallee.createAnswer();
      //Sending the callee sdp to the caller 
      socket.emit("request", { type: "sdpCallee", name: caller, sdp: calleeSdp })
    });

    //Signaling server emiting caller ice candidate 
    socket.on('callerIceCandidate', async callerIceCandidate => {

      if (callerIceCandidate.iceCandidate) {
        //Try to add the caller ice candidate 
        try {
          await pcCallee.addIceCandidate(callerIceCandidate.iceCandidate);
        } catch (e) {
          console.error('Error adding received ice candidate', e);
        }
      }
    });

    socket.on("iceCandidate", async iceCandidate => {
      //reception objet Ice et creation peer to peer datachannel


    });
    socket.on("disconnection", senderName2 => {

    });

    const acceptButton = document.getElementsByClassName("Accept");
    document.addEventListener('click', function (e) {
      if (e.target && e.target.className == 'offerButton') {
        //Caller sending his offer to the callee 
        socket.emit("request", { type: "offer", name: e.target.id });
        console.log(e.target.id);
      }
      if (e.target && e.target.className == 'acceptButton') {
        //callee accepted the offer and sending back his answer to the caller 
        socket.emit("request", { type: "answer", name: e.target.id });
        console.log(e.target.id);
        var caller = e.target.id;
      }

    });
    /*for (let i = 0; i < offerButton.length; i++) {
      offerButton[i].addEventListener("click", function (event) {
        let name = this.id;
        socket.emit("request", { type: "offer", userName: name });
        console.log("emit offer");
      });
    }*/


  </script>
</body>

</html>