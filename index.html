<!DOCTYPE html>
<html>

<head>
  <title>Socket.IO chat</title>

</head>

<body>
  <button id="connect">connect</button>
  <button class="offerButton">Make an offer</button>
  <button class="Accept">Accept Call</button>
  <script src="/socket.io/socket.io.js"></script>
  <div id="cells">
    <div id="user">
    </div>
  </div>
  <script>
    var socket = io();
    var userName = "patoche" + Math.random();

    socket.emit("request", msg = { type: "login", name: userName });



    /*
    var firstName = ...
    var lastName = ...
   */
    /*
      document.getElementById("connect").addEventListener("click", function (event) {
        socket.emit("request", { type: "login", name: userName + Math.random() });
      });
  */

    var userList = new Array();

    var cells = document.getElementById("cells");
    socket.on("getUsers", users => {
      for (let i = 0; i < users.length; i++) {
        addUsers(users[i]);
      }
    });

    function addUsers(user) {
      userList.push(user);
      let id = userList.length;
      //Add to the list of user on the UI 
      cells.innerHTML += `<div id="user${id}">${user}
                              <button class="offerButton" id="${user}">Make an offer</button>
                          </div>`
    }

    socket.on("newUser", user => {
      addUsers(user);
    });

    socket.on("connectedUsers", usersAlreadyConnected => {
      for (let i = 0; i < usersAlreadyConnected.length; i++) {
        addUsers(usersAlreadyConnected[i]);
      }
    });



    socket.on("offer", senderName => {
      console.log("Demande de connexion de:" + senderName);
      cells.innerHTML += `<button class=acceptButton id=${userName}>Accept offer send by:${senderName}</button>`;
      /* document.getElementById("Accept").addEventListener("click", function (event) {
         socket.emit("request", { type: "answer", name: senderName });*/
    });





    socket.on("answer", senderName1 => {
      console.log("Connexion acceptÃ©" + senderName1);

    });
    socket.on("candidate", iceCandidate => {
      //reception objet Ice et creation peer to peer datachannel




    });
    socket.on("disconnection", senderName2 => {

    });

    const acceptButton = document.getElementsByClassName("Accept");
    document.addEventListener('click', function (e) {
      if (e.target && e.target.className == 'offerButton') {
        //do something
        socket.emit("request", { type: "offer", name: e.target.id });
        console.log(e.target.id);
      }
      if (e.target && e.target.className == 'acceptButton') {
        //do something
        socket.emit("request", { type: "answer", name: e.target.id });
        console.log(e.target.id);
      }

    });
    /*for (let i = 0; i < offerButton.length; i++) {
      offerButton[i].addEventListener("click", function (event) {
        let name = this.id;
        socket.emit("request", { type: "offer", userName: name });
        console.log("emit offer");
      });
    }*/


  </script>
</body>

</html>